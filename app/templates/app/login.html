{% extends 'base.html' %}
{% block content %}
{% load static %}

<br>

<h2 style="text-align:center;">Iniciar Sesión</h2>
<hr>

<form method="POST">
    {% csrf_token %}
    <br><br>
    <label>Correo o usuario:</label>
    <input type="text" name="login" required>

    <br><br>

    <label>Contraseña:</label>
    <input type="password" name="password" required>

    <br><br><br>

    <button type="submit" class="btn" style="background-color:rgb(255,66,1); color: white;">Ingresar</button>

    {% if error %}
        <br><br>
        <p style="color:red">{{ error }}</p>
    {% endif %}
</form>

<br><br><br>

<div class="Form">
  <h3>Indicadores Económicos (API Mindicador)</h3>
  <hr>

  <p><strong>TPM:</strong> {{ tpm_actual|default:"No disponible" }}</p>
  <p><strong>CLP → PEN:</strong> {{ tc_clp_pen|default:"No disponible" }}</p>
  <p><strong>CLP → COP:</strong> {{ tc_clp_cop|default:"No disponible" }}</p>
  <p><strong>Dólar actual:</strong> {{ valor_dolar|default:"No disponible" }}</p>
  <p><strong>UF actual:</strong> {{ valor_uf|default:"No disponible" }}</p>
</div>

<br><br>

<h2 style="text-align:center;">Dashboard Económico</h2>
<hr>

<!-- Canvas para gráficos -->
<h3>Dólar últimos 10 días</h3>
<canvas id="graf1" style="max-width:600px; margin:auto;"></canvas>

<h3>Comparación CLP</h3>
<canvas id="graf2" style="max-width:600px; margin:auto;"></canvas>

<h3>UF y Dólar</h3>
<canvas id="graf3" style="max-width:600px; margin:auto;"></canvas>

<!-- Pasar datos de Django a JS -->
{{ fechas|json_script:"fechas-data" }}
{{ valores|json_script:"valores-data" }}
{{ tc_clp_pen|default:"0"|json_script:"tcClpPen-data" }}
{{ tc_clp_cop|default:"0"|json_script:"tcClpCop-data" }}
{{ valor_dolar|default:"0"|json_script:"valorDolar-data" }}
{{ valor_uf|default:"0"|json_script:"valorUf-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const fechas = JSON.parse(document.getElementById('fechas-data').textContent || '[]');
const valores = JSON.parse(document.getElementById('valores-data').textContent || '[]');
const tcClpPen = parseFloat(document.getElementById('tcClpPen-data').textContent || '0');
const tcClpCop = parseFloat(document.getElementById('tcClpCop-data').textContent || '0');
const valorDolar = parseFloat(document.getElementById('valorDolar-data').textContent || '0');
const valorUf = parseFloat(document.getElementById('valorUf-data').textContent || '0');

console.log("CLP → PEN:", tcClpPen);
console.log("CLP → COP:", tcClpCop);

// Gráfico 1: Dólar histórico
new Chart(document.getElementById("graf1"), {
    type: "line",
    data: {
        labels: fechas,
        datasets: [{
            label: "USD (CLP)",
            data: valores,
            borderWidth: 2,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            fill: true
        }]
    },
    options: {
        responsive: true,
        scales: { y: { beginAtZero: false } }
    }
});

// Gráfico 2: CLP -> PEN vs CLP -> COP con ejes separados
new Chart(document.getElementById("graf2"), {
    type: "bar",
    data: {
        labels: ["Valores"], // una sola categoría
        datasets: [
            {
                label: "CLP → PEN",
                data: [tcClpPen],
                backgroundColor: 'rgba(255, 99, 132, 0.5)',
                borderColor: 'rgb(255, 99, 132)',
                borderWidth: 2,
                yAxisID: 'y1'
            },
            {
                label: "CLP → COP",
                data: [tcClpCop],
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgb(54, 162, 235)',
                borderWidth: 2,
                yAxisID: 'y2'
            }
        ]
    },
    options: {
        responsive: true,
        scales: {
            y1: { type: 'linear', position: 'left', beginAtZero: true },
            y2: { type: 'linear', position: 'right', beginAtZero: true },
            x: { barPercentage: 0.4, categoryPercentage: 0.5 }
        }
    }
});

// Gráfico 3: UF vs Dólar con ejes separados
new Chart(document.getElementById("graf3"), {
    type: "bar",
    data: {
        labels: ["Valores"],
        datasets: [
            {
                label: "Dólar",
                data: [valorDolar],
                backgroundColor: 'rgba(255, 206, 86, 0.5)',
                borderColor: 'rgb(255, 206, 86)',
                borderWidth: 2,
                yAxisID: 'y1'
            },
            {
                label: "UF",
                data: [valorUf],
                backgroundColor: 'rgba(75, 192, 192, 0.5)',
                borderColor: 'rgb(75, 192, 192)',
                borderWidth: 2,
                yAxisID: 'y2'
            }
        ]
    },
    options: {
        responsive: true,
        scales: {
            y1: { type: 'linear', position: 'left', beginAtZero: true },
            y2: { type: 'linear', position: 'right', beginAtZero: true },
            x: { barPercentage: 0.5, categoryPercentage: 0.5 }
        }
    }
});
</script>

{% endblock %}
